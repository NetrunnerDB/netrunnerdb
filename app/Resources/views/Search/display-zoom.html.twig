{% extends '/Search/display.html.twig' %}

{% block head %}
    <script src="{{ asset('/js/zoom.js') }}"></script>
    <script type="text/javascript">
        NRDB.user.params.card_id = {{ cards[0].id|json_encode|raw }};
    </script>
{% endblock %}

{% block main %}
{% include '/Scripts/api.html.twig' %}
<script type="text/javascript">
    async function getPronouns() {
        // Attempt to get card's pronouns
        const printing = await fetchData(`${v3_api_url}/api/v3/public/printings/{{ card.code }}`);
        if (printing.attributes.pronouns) {
            $(".card-stats").append(`<br>Pronouns: ${printing.attributes.pronouns}`)
        }
    }
    getPronouns();
</script>

<div class="row">
    <div class="col-sm-4">
        <div class="card-image">
            {% if card.imageUrl %}
            <img data-src="{{ card_image_url }}{{ asset(card.large_image_path) }}" alt="{{ card.title }}" class="img-responsive lazyload card-image" style="margin:auto">
            {% else %}
            <div class="no-image" style="margin:auto"><div class="no-image-text">No image</div></div>
            {% endif %}
        </div>
    </div>

    <div class="col-sm-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title card-title" style="display: flex; justify-content: space-between">
                    <span class="card-title{% if card.available == false %} card-preview{% endif %}">
                        {% if card.uniqueness == true %}&diams;{% endif %}
                        {{ card.title }}
                    </span>
                    <span class="card-cost">
                        {% if card.type_code == "agenda" %}
                            {{ card.advancementcost }}/{{ card.agendapoints }}<span class="icon icon-agenda-points"></span>
                        {% endif %}
                        {% if card.type_code != "identity" and card.type_code != "agenda" %}
                            <abbr title="{{ card.cost }} Credit{{ card.cost != 1 ? 's' : '' }}">{{ card.formatted_cost|raw }}</abbr>
                        {% endif %}
                    </span>
                </h3>
            </div>

            <div class="panel-body card-panel">
                <div class="card-type">
                    {{ card.formatted_type|raw }}
                </div>

                <div class="card-stats">
                    {% if card.type_code == "identity" %}
                        Deck size: {{ card.minimumdecksize }}
                        &bull;
                        Influence:
                        {% if card.influencelimit ?? 0 == 0 %}&#8734;{% else %}{{ card.influencelimit }}{% endif %}
                        {% if card.side_code == "runner" %}
                            &bull;
                            Link: {{ card.baselink }}
                        {% endif %}
                    {% elseif card.type_code in ["event", "operation"] %}
                        {% if card.trash is not null %}
                            Trash: {{ card.trash }}
                        {% endif %}
                    {% elseif card.type_code in ["asset", "upgrade"] %}
                        Trash: {{ card.trash }}
                    {% elseif card.type_code == "program" %}
                        Memory: {{ card.memoryunits }}
                        &bull;
                        Strength: {{ card.strength ?? "-" }}
                    {% elseif card.type_code == "ice" %}
                        Strength: {{ card.strength }}
                        {% if card.trash is not null %}
                            &bull;
                            Trash: {{ card.trash }}
                        {% endif %}
                    {% endif %}
                </div>

                {% if card.type_code != "identity" and card.faction_cost_dots|length > 0 %}
                    <div class="card-influence">
                        Influence:
                        <svg class="typeIcon" aria-label="{{ card.faction_name }}" data-icon-color="{{ card.faction_code }}"><use xlink:href="/images/icons.svg#faction-{{ card.faction_code }}"></use></svg>
                        {# Singular line, as it creates whitespace otherwise #}
                        <span aria-label="{{ card.factioncost }} Influence" style="font-size: 0px;">{{ card.factioncost }}</span><span aria-hidden="true" style="user-select: none;">{{ card.faction_cost_dots|raw }}</span>
                    </div>
                {% endif %}

                {% if card.text|length > 0 %}
                    <div class="card-text border-{{ card.faction_code }}">
                        {{ card.text|raw }}
                    </div>
                {% endif %}

                <div class="card-flavor">
                    {% if card.code == "33084" %}
                        {{ card.flavor|raw|escape|nl2br }}
                    {% elseif card.flavor %}
                        {{ card.flavor|raw|nl2br }}
                    {% endif %}
                </div>

                {% if card.illustrator %}
                    <div class="card-illustrator">
                        <small>
                            Illustrated by {{
                                card.illustrators |
                                map(i => "<a href=\"#{ path('cards_find',{type:'find',_locale:app.request.locale,'view':'images','q':'i:"' ~ i ~ '"'}) }\">#{i}</a>") |
                                join(', ') |
                                raw
                            }}
                            </a>
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>
        <a href="{{ path('decklists_list', {type:'find',_locale:app.request.locale, 'cards[]':card.code}) }}">Decklists with this card</a>
    </div>

    <div class="col-sm-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <span class="icon icon-{{ card.cycle_code }}"></span> {{ card.pack_name}} ({{ card.pack_code }})
                </h3>
                #{{ card.position }} &bull;
                <a href="{{ path('cards_zoom',{_locale:app.request.locale, 'card_code':card.code}) }}"> English </a>
            </div>

            <div class="panel-body">
                <table>
                    <thead>
                        <tr>
                            <th class="legality-{{ card.startup_legality }}"> Startup Card Pool</th>
                        </tr>
                        <tr>
                            <th
                                {% for mwl_info in card.mwl_info %}
                                  {% if mwl_info.active %}
                                    {% if card.standard_legality == 'available' %}
                                      class="legality-{{ mwl_info.legality }}"
                                    {% else %}
                                      class="legality-{{ card.standard_legality }}"
                                    {% endif %}
                                  {% endif %}
                                {% endfor %}
                            > Standard Card Pool</th>
                        </tr>
                        <tr>
                            <th>
                                <span
                                  {% for mwl_info in card.mwl_info %}
                                    {% if mwl_info.active %}
                                      class="legality-{{ mwl_info.legality }}"
                                    {% endif %}
                                  {% endfor %}> Standard Ban List</span>
                                  <a id="mwl-history" href="">(show history)</a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="card-mwl-inactive" style="display:none; height: 10px;"></tr>
                        {% for mwl_info in card.mwl_info %}
                        <tr class="card-mwl-inactive" style="display:none">
                            <td class="legality-{{ mwl_info.legality }}">
                                {{ mwl_info.mwl_name }}{% if mwl_info.active %} (active) {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="panel-body">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <span>Printings</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for version in card.versions %}
                        <tr>
                            <td>
                                <a href="{{ path('cards_zoom',{_locale:app.request.locale, 'card_code':version.code}) }}">
                                    <span class="icon icon-{{ version.cycle_code }}"></span> {{ version.pack_name }}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12 rulings" data-card-id="{{ card.id }}" style="margin-top:2em">
        <div style="line-height:34px" class="rulings-header">
            <span style="font-size:24px">Rulings</span>
        </div>
        {% if card.rulings|length %}
        <ul class="rulings-list">
            {% for ruling in card.rulings %}
            <li data-ruling-id="{{ ruling.id }}" data-ruling-text="{{ ruling.rawtext }}" data-ruling-nsg-rules-team-verified="{{ ruling.nsg_rules_team_verified ? 'true' : 'false'}}" class="{% if ruling.nsg_rules_team_verified %}legality-verified{% else %}legality-unverified{% endif %}">
                <em>Updated {{ ruling.date_update | date("Y-m-d") }}</em>
                {{ ruling.text | raw }}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p><i>No rulings yet for this card.</i></p>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-12" style="margin-top:2em">
        <div style="line-height:34px" class="reviews-header">
            <span style="font-size:24px">Reviews</span>
        </div>
        <form method="POST" action="{{ path('card_review_post') }}" style="clear:right" class="review-edit-form">
            <input type="hidden" name="card_id" value="{{ card.id }}">
            <input type="hidden" name="review_id" value="">
        </form>
        {% if card.reviews|length %}
        {% for review in card.reviews %}
        <article class="review" data-index="{{ review.id }}" id="review-{{ review.id }}">

            <div class="review-like">
                <a href="#" class="review-social-icon-like social-icon-like" data-toggle="tooltip" data-placement="bottom" title="Like that review">
                    <span class="glyphicon glyphicon-heart"></span> <span class="num">{{ review.nbvotes }}</span>
                </a>
            </div>
            <div class="review-content">
                <div class="review-text">
                    {{ review.text|raw }}
                </div>
                <div class="review-date">
                    <time datetime="{{ review.date_creation|date('c') }}">{{ review.date_creation|date('j M Y') }}</time>
                </div>
                <div class="review-latestpack">
                    (<i>{{ review.latestpack }}</i> era)
                </div>
                <div class="review-author">
                    <a href="{{ path('user_profile_view', {user_id:review.author_id,user_name:review.author_name|e('url')}) }}" rel="author" class="username {{ review.author_color }}">{{ review.author_name }}</a>
                    {% if review.author_donation > 0 %}<span class="glyphicon glyphicon-gift donator" title="NetrunnerDB Gracious Donator"></span>{% endif %}
                    <small class="reputation">{{ review.author_reputation }}</small>
                </div>

                {% if review.comments|length %}

                {% for comment in review.comments %}
                <div class="review-comment text-muted small">{{ comment.text|raw }}
                    &mdash;
                    <a title="{{ comment.author.reputation }} reputation" href="{{ path('user_profile_view', {user_id:comment.author.id,user_name:comment.author.username|e('url')}) }}" rel="author" class="username {{ comment.author.faction }}">{{ comment.author.username }}</a>
                    {% if comment.author.donation > 0 %}<span class="glyphicon glyphicon-gift donator" title="NetrunnerDB Gracious Donator"></span>{% endif %}
                    <time datetime="{{ comment.dateCreation|date('c') }}">{{ comment.dateCreation|date('j M Y') }}</time>
                </div>
                {% endfor %}

                {% endif %}
                {% if comments_enabled %}
                  <form action="{{ path('card_reviewcomment_post') }}" method="POST" class="form-comment">
                      <input type="hidden" name="comment_review_id" value="{{ review.id }}">
                      <button class="btn btn-link btn-write-comment">Add a comment</button>
                  </form>
                {% endif %}
            </div>
        </article>
        {% endfor %}
        {% else %}
        <p><i>No reviews yet for this card.</i></p>
        {% endif %}
    </div>
</div>

    <!-- Modal -->
    <div class="modal hidden-print" id="addRulingModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-title">Add a ruling</h3>
                </div>
                <div class="modal-body">
                    <form class="form" role="form" action="{{ path('card_ruling_post') }}" method="post">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <input type="hidden" id="add-ruling-card-id" name="card_id">
                                    <textarea class="form-control" id="add-ruling-form-text" name="text"></textarea>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="well text-muted" id="add-ruling-form-preview"><small>Preview.</small></div>
                            </div>
                            <div class="col-sm-12">
                                <input type="checkbox" id="nsg_rules_team_verified" name="nsg_rules_team_verified" value="true"> <label for="nsg_rules_team_verified">NSG Rules Team Verified Ruling?</label>
                            </div>
                            <div class="col-sm-12">
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->

    <!-- Modal -->
    <div class="modal hidden-print" id="editRulingModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-title">Edit a ruling</h3>
                </div>
                <div class="modal-body">
                    <form class="form" role="form" action="{{ path('card_ruling_edit') }}" method="post">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <input type="hidden" id="edit-ruling-card-id" name="card_id">
                                    <input type="hidden" id="edit-ruling-id" name="ruling_id">
                                    <textarea class="form-control" id="edit-ruling-form-text" name="text"></textarea>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="well text-muted" id="edit-ruling-form-preview"><small>Preview.</small></div>
                            </div>
                            <div class="col-sm-12">
                                <input type="checkbox" id="edit-ruling-nsg-rules-team-verified" name="nsg_rules_team_verified" value="true"> <label for="edit-ruling-nsg-rules-team-verified">NSG Rules Team Verified Ruling?</label>
                            </div>
                            <div class="col-sm-12">
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->

    <!-- Modal -->
    <div class="modal hidden-print" id="deleteRulingModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-title">Delete a ruling</h3>
                </div>
                <div class="modal-body">
                    <form class="form" role="form" action="{{ path('card_ruling_delete') }}" method="post">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <input type="hidden" id="delete-ruling-id" name="ruling_id">
                                    <label>Confirm deletion?</label>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <button type="submit" class="btn btn-primary">Delete</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
{% endblock %}
